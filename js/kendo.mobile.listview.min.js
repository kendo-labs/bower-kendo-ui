/**
 * Copyright 2014 Telerik AD
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * Copyright 2014 Telerik AD
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

!function(e,define){define(["./kendo.data.min","./kendo.userevents.min","./kendo.mobile.button.min"],e)}(function(){return function(e,t){function n(){return this.nodeType===v.TEXT_NODE&&this.nodeValue.match(j)}function i(e,t){t&&!e[0].querySelector(".km-icon")&&e.prepend('<span class="km-icon km-'+t+'"/>')}function r(e){i(e,T(e,"icon")),i(e,T(e.children(C),"icon"))}function a(e){var t=e.parent(),r=e.add(t.children(m.roleSelector("detailbutton"))),a=t.contents().not(r).not(n);a.length||(e.addClass("km-listview-link").attr(m.attr("role"),"listview-link"),i(e,T(t,"icon")),i(e,T(e,"icon")))}function o(e){if(e[0].querySelector("input[type=checkbox],input[type=radio]")){var t=e.parent();t.contents().not(e).not(function(){return 3==this.nodeType})[0]||(e.addClass("km-listview-label"),e.children("[type=checkbox],[type=radio]").addClass("km-widget km-icon km-check"))}}function s(t,n){e(t).css("transform","translate3d(0px, "+n+"px, 0px)")}var l,u,c,d,f,h,p,g,m=window.kendo,v=window.Node,_=m.mobile,b=_.ui,y=m.data.DataSource,w=b.Widget,k=".km-list > li, > li:not(.km-group-container)",x=".km-listview-link, .km-listview-label",C="["+m.attr("icon")+"]",S=e.proxy,T=m.attrValue,F="km-group-title",D="km-state-active",M='<div class="'+F+'"><div class="km-text"></div></div>',E=m.template('<li><div class="'+F+'"><div class="km-text">#= this.headerTemplate(data) #</div></div><ul>#= kendo.render(this.template, data.items)#</ul></li>'),O='<div class="km-listview-wrapper" />',A=m.template('<form class="km-filter-form"><div class="km-filter-wrap"><input type="search" placeholder="#=placeholder#"/><a href="\\#" class="km-filter-reset" title="Clear"><span class="km-icon km-clear"></span><span class="km-text">Clear</span></a></div></form>'),I=".kendoMobileListView",H="styled",z="dataBound",P="dataBinding",B="itemChange",N="click",R="change",V="progress",L="function",j=/^\s+$/,W=/button/,q=m.Class.extend({init:function(e){var t,n,i=e.scroller();i&&(this.options=e.options,this.element=e.element,this.scroller=e.scroller(),this._shouldFixHeaders(),t=this,n=function(){t._cacheHeaders()},e.bind("resize",n),e.bind(H,n),e.bind(z,n),i.bind("scroll",function(e){t._fixHeader(e)}))},_fixHeader:function(t){if(this.fixedHeaders){var n,i,r,a=0,o=this.scroller,s=this.headers,l=t.scrollTop;do{if(n=s[a++],!n){r=e("<div />");break}i=n.offset,r=n.header}while(i+1>l);this.currentHeader!=a&&(o.fixedContainer.html(r.clone()),this.currentHeader=a)}},_shouldFixHeaders:function(){this.fixedHeaders="group"===this.options.type&&this.options.fixedHeaders},_cacheHeaders:function(){if(this._shouldFixHeaders(),this.fixedHeaders){var t=[],n=this.scroller.scrollTop;this.element.find("."+F).each(function(i,r){r=e(r),t.unshift({offset:r.position().top+n,header:r})}),this.headers=t,this._fixHeader({scrollTop:n})}}}),U=function(){return{page:1}},Y=m.Class.extend({init:function(e){var t=this,n=e.options,i=e.scroller(),r=n.pullParameters||U;this.listView=e,this.scroller=i,e.bind("_dataSource",function(e){t.setDataSource(e.dataSource)}),i.setOptions({pullToRefresh:!0,pull:function(){t._pulled=!0,t.dataSource.read(r.call(e,t._first))},pullTemplate:n.pullTemplate,releaseTemplate:n.releaseTemplate,refreshTemplate:n.refreshTemplate})},setDataSource:function(e){var t=this;this._first=e.view()[0],this.dataSource=e,e.bind("change",function(){t._change()})},_change:function(){var e,t=this.scroller,n=this.dataSource;this._pulled&&t.pullHandled(),(this._pulled||!this._first)&&(e=n.view(),e[0]&&(this._first=e[0])),this._pulled=!1}}),G=m.Observable.extend({init:function(e){var t=this;m.Observable.fn.init.call(t),t.buffer=e.buffer,t.height=e.height,t.item=e.item,t.items=[],t.footer=e.footer,t.buffer.bind("reset",function(){t.refresh()})},refresh:function(){for(var e,t,n,i,r=this.buffer,a=this.items,o=!1;a.length;)a.pop().destroy();for(this.offset=r.offset,e=this.item,i=0;r.viewSize>i;i++){if(i===r.total()){o=!0;break}n=e(this.content(this.offset+a.length)),n.below(t),t=n,a.push(n)}this.itemCount=a.length,this.trigger("reset"),this._resize(),o&&this.trigger("endReached")},totalHeight:function(){if(!this.items[0])return 0;var e=this,t=e.items,n=t[0].top,i=t[t.length-1].bottom,r=(i-n)/e.itemCount,a=e.buffer.length-e.offset-e.itemCount;return(this.footer?this.footer.height:0)+i+a*r},batchUpdate:function(e){var t,n,i=this.height(),r=this.items,a=this.offset;if(r[0]){if(this.lastDirection)for(;r[r.length-1].bottom>e+2*i&&0!==this.offset;)this.offset--,t=r.pop(),t.update(this.content(this.offset)),t.above(r[0]),r.unshift(t);else for(;e-i>r[0].top;){if(n=this.offset+this.itemCount,n===this.buffer.total()){this.trigger("endReached");break}if(n===this.buffer.length)break;t=r.shift(),t.update(this.content(this.offset+this.itemCount)),t.below(r[r.length-1]),r.push(t),this.offset++}a!==this.offset&&this._resize()}},update:function(e){var t,n,i,r,a=this,o=this.items,s=this.height(),l=this.itemCount,u=s/2,c=(this.lastTop||0)>e,d=e-u,f=e+s+u;o[0]&&(this.lastTop=e,this.lastDirection=c,c?o[0].top>d&&o[o.length-1].bottom>f+u&&this.offset>0&&(this.offset--,t=o.pop(),n=o[0],t.update(this.content(this.offset)),o.unshift(t),t.above(n),a._resize()):f>o[o.length-1].bottom&&d-u>o[0].top&&(r=this.offset+l,r===this.buffer.total()?this.trigger("endReached"):r!==this.buffer.length&&(t=o.shift(),i=o[o.length-1],o.push(t),t.update(this.content(this.offset+this.itemCount)),a.offset++,t.below(i),a._resize())))},content:function(e){return this.buffer.at(e)},destroy:function(){this.unbind()},_resize:function(){var e=this.items,t=0,n=0,i=e[0],r=e[e.length-1];i&&(t=i.top,n=r.bottom),this.trigger("resize",{top:t,bottom:n}),this.footer&&this.footer.below(r)}});m.mobile.ui.VirtualList=G,l=m.Class.extend({init:function(t,n){var i=t.append([n])[0],r=i.offsetHeight;e.extend(this,{top:0,element:i,listView:t,height:r,bottom:r})},update:function(e){this.element=this.listView.setDataItem(this.element,e)},above:function(e){e&&(this.height=this.element.offsetHeight,this.top=e.top-this.height,this.bottom=e.top,s(this.element,this.top))},below:function(e){e&&(this.height=this.element.offsetHeight,this.top=e.bottom,this.bottom=this.top+this.height,s(this.element,this.top))},destroy:function(){m.destroy(this.element),e(this.element).remove()}}),u='<div><span class="km-icon"></span><span class="km-loading-left"></span><span class="km-loading-right"></span></div>',c=m.Class.extend({init:function(t){this.element=e('<li class="km-load-more km-scroller-refresh" style="display: none"></li>').appendTo(t.element),this._loadIcon=e(u).appendTo(this.element)},enable:function(){this.element.show(),this.height=this.element.outerHeight(!0)},disable:function(){this.element.hide(),this.height=0},below:function(e){e&&(this.top=e.bottom,this.bottom=this.height+this.top,s(this.element,this.top))}}),d=c.extend({init:function(t,n){this._loadIcon=e(u).hide(),this._loadButton=e('<a class="km-load">'+t.options.loadMoreText+"</a>").hide(),this.element=e('<li class="km-load-more" style="display: none"></li>').append(this._loadIcon).append(this._loadButton).appendTo(t.element);var i=this;this._loadButton.kendoMobileButton().data("kendoMobileButton").bind("click",function(){i._hideShowButton(),n.next()}),n.bind("resize",function(){i._showLoadButton()}),this.height=this.element.outerHeight(!0),this.disable()},_hideShowButton:function(){this._loadButton.hide(),this.element.addClass("km-scroller-refresh"),this._loadIcon.css("display","block")},_showLoadButton:function(){this._loadButton.show(),this.element.removeClass("km-scroller-refresh"),this._loadIcon.hide()}}),f=m.Class.extend({init:function(e){var t=this;this.chromeHeight=e.wrapper.children().not(e.element).outerHeight()||0,this.listView=e,this.scroller=e.scroller(),this.options=e.options,e.bind("_dataSource",function(e){t.setDataSource(e.dataSource,e.empty)}),e.bind("resize",function(){t.list.items.length&&(t.scroller.reset(),t.buffer.range(0),t.list.refresh())}),this.scroller.makeVirtual(),this.scroller.bind("scroll",function(e){t.list.update(e.scrollTop)}),this.scroller.bind("scrollEnd",function(e){t.list.batchUpdate(e.scrollTop)})},destroy:function(){this.list.unbind(),this.buffer.unbind()},setDataSource:function(t,n){var i,r,a,o,s=this,u=this.options,f=this.listView,h=f.scroller(),p=u.loadMore;if(this.dataSource=t,i=t.pageSize()||u.virtualViewSize,!i&&!n)throw Error("the DataSource does not have page size configured. Page Size setting is mandatory for the mobile listview virtual scrolling to work as expected.");this.buffer&&this.buffer.destroy(),r=new m.data.Buffer(t,Math.floor(i/2),p),a=p?new d(f,r):new c(f),this.list&&this.list.destroy(),o=new G({buffer:r,footer:a,item:function(e){return new l(f,e)},height:function(){return h.height()}}),o.bind("resize",function(){s.updateScrollerSize()}),o.bind("reset",function(){s.footer.enable()}),o.bind("endReached",function(){a.disable(),s.updateScrollerSize()}),r.bind("expand",function(){o.lastDirection=!1,o.batchUpdate(h.scrollTop)}),e.extend(this,{buffer:r,scroller:h,list:o,footer:a})},updateScrollerSize:function(){this.scroller.virtualSize(0,this.list.totalHeight()+this.chromeHeight)},refresh:function(){this.list.refresh()},reset:function(){this.buffer.range(0),this.list.refresh()}}),h=m.Class.extend({init:function(e){var t,n=this;this.listView=e,this.options=e.options,t=this,this._refreshHandler=function(e){t.refresh(e)},this._progressHandler=function(){e.showLoading()},e.bind("_dataSource",function(e){n.setDataSource(e.dataSource)})},destroy:function(){this._unbindDataSource()},reset:function(){},refresh:function(e){var n,i,r=e&&e.action,a=e&&e.items,o=this.listView,s=this.dataSource,l=this.options.appendOnRefresh,u=s.view(),c=s.group(),d=c&&c[0];return"itemchange"===r?(n=o.findByDataItem(a)[0],n&&o.setDataItem(n,a[0]),t):(o.trigger(P),"add"!==r||d?"remove"!==r||d?d?o.replaceGrouped(u):l&&!o._filter?o.prepend(u):o.replace(u):o.remove(a):(i=u.indexOf(a[0]),i>-1&&o.insertAt(a,i)),this._shouldShowLoading()&&o.hideLoading(),o.trigger(z,{ns:b}),t)},setDataSource:function(e){this.dataSource&&this._unbindDataSource(),this.dataSource=e,e.bind(R,this._refreshHandler),this._shouldShowLoading()&&this.dataSource.bind(V,this._progressHandler)},_unbindDataSource:function(){this.dataSource.unbind(R,this._refreshHandler).unbind(V,this._progressHandler)},_shouldShowLoading:function(){var e=this.options;return!e.pullToRefresh&&!e.loadMore&&!e.endlessScroll}}),p=m.Class.extend({init:function(e){var t=this,n=e.options.filterable,i="change paste";this.listView=e,this.options=n,e.element.before(A({placeholder:n.placeholder||"Search..."})),n.autoFilter!==!1&&(i+=" keyup"),this.element=e.wrapper.find(".km-search-form"),this.searchInput=e.wrapper.find("input[type=search]").closest("form").on("submit"+I,function(e){e.preventDefault()}).end().on("focus"+I,function(){t._oldFilter=t.searchInput.val()}).on(i.split(" ").join(I+" ")+I,S(this._filterChange,this)),this.clearButton=e.wrapper.find(".km-filter-reset").on(N,S(this,"_clearFilter")).hide()},_search:function(e){this._filter=!0,this.clearButton[e?"show":"hide"](),this.listView.dataSource.filter(e)},_filterChange:function(e){var t=this;"paste"==e.type&&this.options.autoFilter!==!1?setTimeout(function(){t._applyFilter()},1):this._applyFilter()},_applyFilter:function(){var e=this.options,t=this.searchInput.val(),n=t.length?{field:e.field,operator:e.operator||"startsWith",ignoreCase:e.ignoreCase,value:t}:null;t!==this._oldFilter&&(this._oldFilter=t,this._search(n))},_clearFilter:function(e){this.searchInput.val(""),this._search(null),e.preventDefault()}}),g=w.extend({init:function(e,t){var n=this;w.fn.init.call(this,e,t),e=this.element,t=this.options,t.scrollTreshold&&(t.scrollThreshold=t.scrollTreshold),e.on("down",x,"_highlight").on("move up cancel",x,"_dim"),this._userEvents=new m.UserEvents(e,{filter:k,allowSelection:!0,tap:function(e){n._click(e)},end:function(e){(m.mobile.appLevelNativeScrolling()||n.viewHasNativeScrolling())&&e.preventDefault()}}),e.css("-ms-touch-action","auto"),e.wrap(O),this.wrapper=this.element.parent(),this._headerFixer=new q(this),this._itemsCache={},this._templates(),this.virtual=t.endlessScroll||t.loadMore,this._style(),this.options.pullToRefresh&&(this._pullToRefreshHandler=new Y(this)),this.options.filterable&&(this._filter=new p(this)),this._itemBinder=this.virtual?new f(this):new h(this),this.setDataSource(t.dataSource),this._enhanceItems(this.items()),m.notify(this,b)},events:[N,P,z,B],options:{name:"ListView",style:"",type:"flat",autoBind:!0,fixedHeaders:!1,template:"#:data#",headerTemplate:'<span class="km-text">#:value#</span>',appendOnRefresh:!1,loadMore:!1,loadMoreText:"Press to load more",endlessScroll:!1,scrollThreshold:30,pullToRefresh:!1,pullTemplate:"Pull to refresh",releaseTemplate:"Release to refresh",refreshTemplate:"Refreshing",pullOffset:140,filterable:!1,virtualViewSize:null},refresh:function(){this._itemBinder.refresh()},reset:function(){this._itemBinder.reset()},setDataSource:function(e){var t=!e;this.dataSource=y.create(e),this.trigger("_dataSource",{dataSource:this.dataSource,empty:t}),this.options.autoBind&&!t&&(this.items().remove(),this.dataSource.fetch())},destroy:function(){w.fn.destroy.call(this),m.destroy(this.element),this._userEvents.destroy(),this._itemBinder&&this._itemBinder.destroy(),this.element.unwrap(),delete this.element,delete this.wrapper,delete this._userEvents},items:function(){return"group"===this.options.type?this.element.find(".km-list").children():this.element.children().not(".km-load-more")},scroller:function(){return this._scrollerInstance||(this._scrollerInstance=this.element.closest(".km-scroll-wrapper").data("kendoMobileScroller")),this._scrollerInstance},showLoading:function(){var e=this.view();e&&e.loader&&e.loader.show()},hideLoading:function(){var e=this.view();e&&e.loader&&e.loader.hide()},insertAt:function(e,t){var n=this;return this._renderItems(e,function(i){0===t?n.element.prepend(i):-1===t?n.element.append(i):n.items().eq(t-1).after(i);for(var r=0;i.length>r;r++)n.trigger(B,{item:[i[r]],data:e[r],ns:b})})},append:function(e){return this.insertAt(e,-1)},prepend:function(e){return this.insertAt(e,0)},replace:function(e){return this.options.type="flat",this.element.empty(),this._style(),this.insertAt(e,0)},replaceGrouped:function(t){this.options.type="group",this.element.empty();var n=e(m.render(this.groupTemplate,t));this._enhanceItems(n.children("ul").children("li")),this.element.append(n),_.init(n),this._style()},remove:function(e){var t=this.findByDataItem(e);m.destroy(t),t.remove()},findByDataItem:function(e){var t,n,i=[];for(t=0,n=e.length;n>t;t++)i[t]="[data-"+m.ns+"uid="+e[t].uid+"]";return this.element.find(i.join(","))},setDataItem:function(t,n){var i=this,r=function(r){var a=e(r[0]);e(t).replaceWith(a),i.trigger(B,{item:a,data:n,ns:b})};return this._renderItems([n],r)[0]},_renderItems:function(t,n){var i=e(m.render(this.template,t));return n(i),_.init(i),this._enhanceItems(i),i},_dim:function(e){this._toggle(e,!1)},_highlight:function(e){this._toggle(e,!0)},_toggle:function(t,n){if(!(t.which>1)){var i=e(t.currentTarget),r=i.parent(),a=T(i,"role")||"",o=!a.match(W),s=t.isDefaultPrevented();o&&r.toggleClass(D,n&&!s)}},_templates:function(){var e=this.options.template,t=this.options.headerTemplate,n=' data-uid="#=arguments[0].uid || ""#"',i={},r={};typeof e===L&&(i.template=e,e="#=this.template(data)#"),this.template=S(m.template("<li"+n+">"+e+"</li>"),i),r.template=this.template,typeof t===L&&(r._headerTemplate=t,t="#=this._headerTemplate(data)#"),r.headerTemplate=m.template(t),this.groupTemplate=S(E,r)},_click:function(t){if(!(t.event.which>1||t.event.isDefaultPrevented())){var n,i=t.target,r=e(t.event.target),a=r.closest(m.roleSelector("button","detailbutton","backbutton")),o=m.widgetInstance(a,b),s=i.attr(m.attr("uid"));s&&(n=this.dataSource.getByUid(s)),this.trigger(N,{target:r,item:i,dataItem:n,button:o})&&t.preventDefault()}},_styleGroups:function(){var t=this.element.children();t.children("ul").addClass("km-list"),t.each(function(){var t=e(this),n=t.contents().first();t.addClass("km-group-container"),n.is("ul")||n.is("div."+F)||n.wrap(M)})},_style:function(){var e=this.options,t="group"===e.type,n=this.element,i="inset"===e.style;n.addClass("km-listview").toggleClass("km-list",!t).toggleClass("km-virtual-list",this.virtual).toggleClass("km-listinset",!t&&i).toggleClass("km-listgroup",t&&!i).toggleClass("km-listgroupinset",t&&i),n.parents(".km-listview")[0]||n.closest(".km-content").toggleClass("km-insetcontent",i),t&&this._styleGroups(),this.trigger(H)},_enhanceItems:function(t){t.each(function(){var t,n=e(this),i=!1;n.children().each(function(){t=e(this),t.is("a")?(a(t),i=!0):t.is("label")&&(o(t),i=!0)}),i||r(n)})}}),b.plugin(g)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t){t()});